import streamlit as st
import sqlite3
import uuid
import time
import random
from datetime import datetime

# Initialize database
def init_database():
    """Initialize the database with required tables"""
    try:
        conn = sqlite3.connect('quiz_app.db')
        cursor = conn.cursor()
        
        # Create quiz_results table
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS quiz_results (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id TEXT NOT NULL,
                category TEXT NOT NULL,
                difficulty TEXT NOT NULL,
                score INTEGER NOT NULL,
                total_questions INTEGER NOT NULL,
                percentage REAL NOT NULL,
                time_taken INTEGER NOT NULL,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        ''')
        
        # Create index for better performance
        cursor.execute('''
            CREATE INDEX IF NOT EXISTS idx_user_id 
            ON quiz_results(user_id)
        ''')
        
        conn.commit()
        conn.close()
        print("Database initialized successfully")
    except sqlite3.Error as e:
        print(f"Database initialization error: {e}")

# Database Manager Class
class QuizDatabase:
    def __init__(self, db_path='quiz_app.db'):
        self.db_path = db_path
        self.init_database()
    
    def init_database(self):
        """Initialize database tables"""
        try:
            conn = sqlite3.connect(self.db_path)
            cursor = conn.cursor()
            
            cursor.execute('''
                CREATE TABLE IF NOT EXISTS quiz_results (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    user_id TEXT NOT NULL,
                    category TEXT NOT NULL,
                    difficulty TEXT NOT NULL,
                    score INTEGER NOT NULL,
                    total_questions INTEGER NOT NULL,
                    percentage REAL NOT NULL,
                    time_taken INTEGER NOT NULL,
                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                )
            ''')
            
            cursor.execute('''
                CREATE INDEX IF NOT EXISTS idx_user_id 
                ON quiz_results(user_id)
            ''')
            
            conn.commit()
            conn.close()
            return True
        except sqlite3.Error as e:
            print(f"Database initialization error: {e}")
            return False
    
    def save_quiz_result(self, user_id, category, difficulty, score, total_questions, percentage, time_taken):
        """Save quiz result to database"""
        try:
            conn = sqlite3.connect(self.db_path)
            cursor = conn.cursor()
            
            cursor.execute('''
                INSERT INTO quiz_results (user_id, category, difficulty, score, total_questions, percentage, time_taken)
                VALUES (?, ?, ?, ?, ?, ?, ?)
            ''', (user_id, category, difficulty, score, total_questions, percentage, time_taken))
            
            conn.commit()
            conn.close()
            return True
        except sqlite3.Error as e:
            print(f"Database save error: {e}")
            return False
    
    def get_user_results(self, user_id):
        """Get all quiz results for a user"""
        try:
            conn = sqlite3.connect(self.db_path)
            cursor = conn.cursor()
            
            cursor.execute('''
                SELECT * FROM quiz_results 
                WHERE user_id = ? 
                ORDER BY created_at DESC
            ''', (user_id,))
            
            results = cursor.fetchall()
            conn.close()
            
            # Convert to list of dictionaries
            columns = ['id', 'user_id', 'category', 'difficulty', 'score', 
                      'total_questions', 'percentage', 'time_taken', 'created_at']
            return [dict(zip(columns, row)) for row in results]
        except sqlite3.Error as e:
            print(f"Database fetch error: {e}")
            return []
    
    def get_user_average_score(self, user_id):
        """Get average score for a user"""
        try:
            conn = sqlite3.connect(self.db_path)
            cursor = conn.cursor()
            
            cursor.execute('''
                SELECT AVG(percentage) FROM quiz_results 
                WHERE user_id = ?
            ''', (user_id,))
            
            result = cursor.fetchone()
            conn.close()
            return result[0] if result[0] else 0.0
        except sqlite3.Error as e:
            print(f"Database average error: {e}")
            return 0.0

# Initialize database instance
db = QuizDatabase()

# Quiz questions database
QUIZ_QUESTIONS = {
    "Mathematics": {
        "Easy": [
            {
                "question": "What is 2 + 2?",
                "options": ["3", "4", "5", "6"],
                "correct_answer": "4"
            },
            {
                "question": "What is 5 Ã— 3?",
                "options": ["10", "15", "20", "25"],
                "correct_answer": "15"
            },
            {
                "question": "What is 10 Ã· 2?",
                "options": ["2", "5", "10", "20"],
                "correct_answer": "5"
            },
            {
                "question": "What is 8 - 3?",
                "options": ["3", "4", "5", "6"],
                "correct_answer": "5"
            },
            {
                "question": "What is 7 + 8?",
                "options": ["13", "14", "15", "16"],
                "correct_answer": "15"
            }
        ],
        "Medium": [
            {
                "question": "What is 12 Ã— 12?",
                "options": ["121", "144", "132", "156"],
                "correct_answer": "144"
            },
            {
                "question": "What is 45 Ã· 9?",
                "options": ["4", "5", "6", "7"],
                "correct_answer": "5"
            },
            {
                "question": "What is 25 + 37?",
                "options": ["52", "62", "72", "82"],
                "correct_answer": "62"
            },
            {
                "question": "What is 100 - 45?",
                "options": ["45", "55", "65", "75"],
                "correct_answer": "55"
            },
            {
                "question": "What is 9 Ã— 7?",
                "options": ["56", "63", "72", "81"],
                "correct_answer": "63"
            }
        ],
        "Hard": [
            {
                "question": "What is 15% of 200?",
                "options": ["15", "20", "25", "30"],
                "correct_answer": "30"
            },
            {
                "question": "Solve: 3x + 5 = 20",
                "options": ["x = 3", "x = 4", "x = 5", "x = 6"],
                "correct_answer": "x = 5"
            },
            {
                "question": "What is the square root of 169?",
                "options": ["11", "12", "13", "14"],
                "correct_answer": "13"
            },
            {
                "question": "What is 2Â³ + 3Â²?",
                "options": ["10", "12", "15", "17"],
                "correct_answer": "17"
            },
            {
                "question": "What is 7! Ã· 6!?",
                "options": ["6", "7", "8", "9"],
                "correct_answer": "7"
            }
        ]
    },
    "Science": {
        "Easy": [
            {
                "question": "What planet is known as the Red Planet?",
                "options": ["Venus", "Mars", "Jupiter", "Saturn"],
                "correct_answer": "Mars"
            },
            {
                "question": "How many bones are in the human body?",
                "options": ["106", "196", "206", "216"],
                "correct_answer": "206"
            },
            {
                "question": "What is Hâ‚‚O?",
                "options": ["Oxygen", "Hydrogen", "Water", "Carbon Dioxide"],
                "correct_answer": "Water"
            },
            {
                "question": "What gas do plants absorb?",
                "options": ["Oxygen", "Carbon Dioxide", "Nitrogen", "Hydrogen"],
                "correct_answer": "Carbon Dioxide"
            },
            {
                "question": "What is the closest star to Earth?",
                "options": ["Proxima Centauri", "Sirius", "Sun", "Alpha Centauri"],
                "correct_answer": "Sun"
            }
        ],
        "Medium": [
            {
                "question": "What is the chemical symbol for gold?",
                "options": ["Go", "Gd", "Au", "Ag"],
                "correct_answer": "Au"
            },
            {
                "question": "What is the speed of light?",
                "options": ["299,792 km/s", "150,000 km/s", "450,000 km/s", "1,000,000 km/s"],
                "correct_answer": "299,792 km/s"
            },
            {
                "question": "What is the main gas in Earth's atmosphere?",
                "options": ["Oxygen", "Carbon Dioxide", "Nitrogen", "Hydrogen"],
                "correct_answer": "Nitrogen"
            },
            {
                "question": "What is photosynthesis?",
                "options": [
                    "Process of converting light energy to chemical energy",
                    "Process of breathing",
                    "Process of digestion",
                    "Process of reproduction"
                ],
                "correct_answer": "Process of converting light energy to chemical energy"
            },
            {
                "question": "What is the smallest unit of life?",
                "options": ["Atom", "Cell", "Molecule", "Organ"],
                "correct_answer": "Cell"
            }
        ],
        "Hard": [
            {
                "question": "What is the atomic number of carbon?",
                "options": ["6", "8", "12", "14"],
                "correct_answer": "6"
            },
            {
                "question": "What is Newton's first law of motion?",
                "options": [
                    "F = ma",
                    "Law of inertia",
                    "Action-reaction",
                    "Law of gravitation"
                ],
                "correct_answer": "Law of inertia"
            },
            {
                "question": "What is the pH of pure water?",
                "options": ["5", "6", "7", "8"],
                "correct_answer": "7"
            },
            {
                "question": "What is the powerhouse of the cell?",
                "options": ["Nucleus", "Mitochondria", "Ribosome", "Golgi Apparatus"],
                "correct_answer": "Mitochondria"
            },
            {
                "question": "What is the formula for kinetic energy?",
                "options": ["mvÂ²", "Â½mvÂ²", "mgh", "Fd"],
                "correct_answer": "Â½mvÂ²"
            }
        ]
    },
    "English": {
        "Easy": [
            {
                "question": "Which word is a noun?",
                "options": ["run", "beautiful", "quickly", "cat"],
                "correct_answer": "cat"
            },
            {
                "question": "What is the past tense of 'go'?",
                "options": ["goed", "went", "gone", "going"],
                "correct_answer": "went"
            },
            {
                "question": "Which is a correct sentence?",
                "options": [
                    "She don't like apples",
                    "She doesn't like apples",
                    "She doesn't likes apples",
                    "She don't likes apples"
                ],
                "correct_answer": "She doesn't like apples"
            },
            {
                "question": "What is the plural of 'child'?",
                "options": ["childs", "children", "childes", "childern"],
                "correct_answer": "children"
            },
            {
                "question": "Which word is an adjective?",
                "options": ["happiness", "beautiful", "run", "quickly"],
                "correct_answer": "beautiful"
            }
        ],
        "Medium": [
            {
                "question": "What is a synonym for 'happy'?",
                "options": ["sad", "joyful", "angry", "tired"],
                "correct_answer": "joyful"
            },
            {
                "question": "Which sentence is in passive voice?",
                "options": [
                    "The cat chased the mouse",
                    "The mouse was chased by the cat",
                    "The cat is chasing the mouse",
                    "The cat will chase the mouse"
                ],
                "correct_answer": "The mouse was chased by the cat"
            },
            {
                "question": "What is the correct punctuation?",
                "options": [
                    "What time is it.",
                    "What time is it?",
                    "What time is it!",
                    "What time is it,"
                ],
                "correct_answer": "What time is it?"
            },
            {
                "question": "Which word is a preposition?",
                "options": ["run", "under", "beautiful", "quickly"],
                "correct_answer": "under"
            },
            {
                "question": "What is the opposite of 'ancient'?",
                "options": ["old", "modern", "historic", "aged"],
                "correct_answer": "modern"
            }
        ],
        "Hard": [
            {
                "question": "What is an oxymoron?",
                "options": [
                    "A figure of speech with contradictory terms",
                    "A type of poem",
                    "A grammatical error",
                    "A spelling mistake"
                ],
                "correct_answer": "A figure of speech with contradictory terms"
            },
            {
                "question": "What is the literary term for 'the rain wept'?",
                "options": ["Simile", "Metaphor", "Personification", "Hyperbole"],
                "correct_answer": "Personification"
            },
            {
                "question": "Which is a complex sentence?",
                "options": [
                    "I went to the store",
                    "I went to the store and bought milk",
                    "Although it was raining, I went to the store",
                    "Store, milk, bread"
                ],
                "correct_answer": "Although it was raining, I went to the store"
            },
            {
                "question": "What is the meaning of 'ephemeral'?",
                "options": ["Eternal", "Temporary", "Beautiful", "Complex"],
                "correct_answer": "Temporary"
            },
            {
                "question": "What is the gerund in: 'Swimming is good exercise'?",
                "options": ["Swimming", "is", "good", "exercise"],
                "correct_answer": "Swimming"
            }
        ]
    },
    "General Knowledge": {
        "Easy": [
            {
                "question": "What is the capital of France?",
                "options": ["London", "Berlin", "Paris", "Madrid"],
                "correct_answer": "Paris"
            },
            {
                "question": "How many continents are there?",
                "options": ["5", "6", "7", "8"],
                "correct_answer": "7"
            },
            {
                "question": "What is the largest ocean?",
                "options": ["Atlantic", "Indian", "Arctic", "Pacific"],
                "correct_answer": "Pacific"
            },
            {
                "question": "Who painted the Mona Lisa?",
                "options": ["Van Gogh", "Picasso", "Da Vinci", "Monet"],
                "correct_answer": "Da Vinci"
            },
            {
                "question": "What is the currency of Japan?",
                "options": ["Yuan", "Won", "Yen", "Ringgit"],
                "correct_answer": "Yen"
            }
        ],
        "Medium": [
            {
                "question": "What year did World War II end?",
                "options": ["1944", "1945", "1946", "1947"],
                "correct_answer": "1945"
            },
            {
                "question": "Who wrote 'Romeo and Juliet'?",
                "options": ["Charles Dickens", "William Shakespeare", "Jane Austen", "Mark Twain"],
                "correct_answer": "William Shakespeare"
            },
            {
                "question": "What is the smallest country in the world?",
                "options": ["Monaco", "Vatican City", "San Marino", "Liechtenstein"],
                "correct_answer": "Vatican City"
            },
            {
                "question": "Which element has the chemical symbol 'O'?",
                "options": ["Gold", "Oxygen", "Osmium", "Oganesson"],
                "correct_answer": "Oxygen"
            },
            {
                "question": "What is the longest river in the world?",
                "options": ["Amazon", "Nile", "Yangtze", "Mississippi"],
                "correct_answer": "Nile"
            }
        ],
        "Hard": [
            {
                "question": "Who discovered penicillin?",
                "options": ["Marie Curie", "Alexander Fleming", "Louis Pasteur", "Robert Koch"],
                "correct_answer": "Alexander Fleming"
            },
            {
                "question": "What is the capital of Australia?",
                "options": ["Sydney", "Melbourne", "Canberra", "Perth"],
                "correct_answer": "Canberra"
            },
            {
                "question": "Which planet has the most moons?",
                "options": ["Jupiter", "Saturn", "Uranus", "Neptune"],
                "correct_answer": "Saturn"
            },
            {
                "question": "What is the hardest natural substance?",
                "options": ["Gold", "Iron", "Diamond", "Platinum"],
                "correct_answer": "Diamond"
            },
            {
                "question": "Who was the first woman to win a Nobel Prize?",
                "options": ["Marie Curie", "Rosalind Franklin", "Dorothy Hodgkin", "Maria Goeppert-Mayer"],
                "correct_answer": "Marie Curie"
            }
        ]
    }
}

def show_dashboard():
    """Display the main dashboard"""
    st.title("ğŸ¯ Your Learning Journey")
    
    # User stats
    col1, col2 = st.columns(2)
    
    with col1:
        st.subheader("Total Quizzes")
        user_results = db.get_user_results(st.session_state.user_id)
        total_quizzes = len(user_results)
        st.metric("Quizzes Taken", total_quizzes)
    
    with col2:
        st.subheader("Average Score")
        avg_score = db.get_user_average_score(st.session_state.user_id)
        st.metric("Performance", f"{avg_score:.1f}%")
    
    st.markdown("---")
    
    # Start new quiz section
    st.subheader("ğŸš€ Start New Quiz")
    st.write("Choose Your Challenge")
    
    # Category selection
    cols = st.columns(4)
    categories = ["Mathematics", "Science", "English", "General Knowledge"]
    icons = ["ğŸ”¢", "ğŸ”¬", "ğŸ“š", "ğŸŒ"]
    
    for i, (col, category, icon) in enumerate(zip(cols, categories, icons)):
        with col:
            if st.button(f"{icon}\n{category}", use_container_width=True, key=f"cat_{i}"):
                st.session_state.selected_category = category
                st.session_state.page = 'quiz'
                st.rerun()
    
    st.markdown("---")
    
    # Recent performance
    st.subheader("ğŸ“ˆ Recent Performance")
    
    if user_results:
        # Display last 5 results
        recent_results = user_results[:5]
        for result in recent_results:
            with st.container():
                col1, col2, col3 = st.columns([2, 1, 1])
                
                with col1:
                    # Use defensive programming to handle missing keys
                    category = result.get('category', 'Unknown Category')
                    difficulty = result.get('difficulty', 'Unknown Difficulty')
                    st.write(f"**{category}** - {difficulty}")
                
                with col2:
                    score = result.get('score', 0)
                    total = result.get('total_questions', 0)
                    percentage = result.get('percentage', 0)
                    st.write(f"Score: {score}/{total}")
                
                with col3:
                    # Performance indicator
                    if percentage >= 80:
                        st.success(f"{percentage:.1f}% ğŸ‰")
                    elif percentage >= 60:
                        st.warning(f"{percentage:.1f}% ğŸ‘")
                    else:
                        st.error(f"{percentage:.1f}% ğŸ’ª")
                
                st.divider()
    else:
        st.info("No quiz results yet. Take your first quiz to see your performance here!")

def show_quiz():
    """Display and manage the quiz"""
    st.title("ğŸ§  Quiz Time!")
    
    # Initialize quiz state
    if 'current_question' not in st.session_state:
        st.session_state.current_question = 0
    if 'user_answers' not in st.session_state:
        st.session_state.user_answers = []
    if 'start_time' not in st.session_state:
        st.session_state.start_time = time.time()
    if 'selected_difficulty' not in st.session_state:
        st.session_state.selected_difficulty = "Medium"
    if 'selected_category' not in st.session_state:
        st.session_state.selected_category = "Mathematics"
    
    # Category and difficulty selection at start
    if st.session_state.current_question == 0 and not st.session_state.user_answers:
        col1, col2 = st.columns(2)
        
        with col1:
            category = st.selectbox(
                "Select Category",
                ["Mathematics", "Science", "English", "General Knowledge"],
                key="category_select"
            )
            st.session_state.selected_category = category
        
        with col2:
            difficulty = st.selectbox(
                "Select Difficulty",
                ["Easy", "Medium", "Hard"],
                key="difficulty_select"
            )
            st.session_state.selected_difficulty = difficulty
        
        if st.button("Start Quiz", type="primary"):
            st.session_state.quiz_questions = QUIZ_QUESTIONS[category][difficulty]
            st.rerun()
        
        if st.button("â† Back to Dashboard"):
            st.session_state.page = 'dashboard'
            st.rerun()
        
        return
    
    # Display current question
    current_q = st.session_state.current_question
    questions = st.session_state.quiz_questions
    
    if current_q < len(questions):
        question_data = questions[current_q]
        
        st.subheader(f"Question {current_q + 1} of {len(questions)}")
        st.write(f"**{question_data['question']}**")
        
        # Display options
        user_answer = st.radio(
            "Select your answer:",
            question_data['options'],
            key=f"q_{current_q}"
        )
        
        col1, col2 = st.columns([1, 4])
        
        with col1:
            if st.button("Next Question", type="primary"):
                st.session_state.user_answers.append(user_answer)
                st.session_state.current_question += 1
                st.rerun()
        
        with col2:
            if st.button("â† Back to Dashboard"):
                st.session_state.page = 'dashboard'
                st.rerun()
    
    else:
        # All questions answered - show results
        submit_quiz()

def submit_quiz():
    """Calculate and display quiz results, save to database"""
    try:
        questions = st.session_state.quiz_questions
        user_answers = st.session_state.user_answers
        
        # Calculate score
        score = 0
        for i, question in enumerate(questions):
            if i < len(user_answers) and user_answers[i] == question['correct_answer']:
                score += 1
        
        total_questions = len(questions)
        percentage = (score / total_questions) * 100
        time_taken = time.time() - st.session_state.start_time
        
        # Display results
        st.subheader("ğŸŠ Quiz Completed!")
        
        col1, col2, col3 = st.columns(3)
        
        with col1:
            st.metric("Score", f"{score}/{total_questions}")
        
        with col2:
            st.metric("Percentage", f"{percentage:.1f}%")
        
        with col3:
            st.metric("Time Taken", f"{time_taken:.1f}s")
        
        # Performance message
        if percentage >= 80:
            st.success("ğŸ‰ Excellent work! You're a star!")
        elif percentage >= 60:
            st.warning("ğŸ‘ Good job! Keep practicing!")
        else:
            st.info("ğŸ’ª Keep trying! You'll get better!")
        
        # Save to database
        success = db.save_quiz_result(
            st.session_state.user_id,
            st.session_state.selected_category,
            st.session_state.selected_difficulty,
            score,
            total_questions,
            percentage,
            time_taken
        )
        
        if success:
            st.success("âœ… Results saved successfully!")
        else:
            st.error("âŒ Failed to save results, but don't worry - we'll try again later!")
        
        # Show review of answers
        st.markdown("---")
        st.subheader("ğŸ“‹ Review Your Answers")
        
        for i, question in enumerate(questions):
            with st.container():
                user_answer = user_answers[i] if i < len(user_answers) else "Not answered"
                correct = user_answer == question['correct_answer']
                
                st.write(f"**Q{i+1}: {question['question']}**")
                
                col1, col2 = st.columns(2)
                
                with col1:
                    st.write(f"Your answer: {user_answer}")
                
                with col2:
                    if correct:
                        st.success("âœ… Correct!")
                    else:
                        st.error(f"âŒ Correct answer: {question['correct_answer']}")
                
                st.divider()
        
        # Navigation buttons
        col1, col2, col3 = st.columns(3)
        
        with col1:
            if st.button("ğŸ”„ Take Another Quiz", use_container_width=True):
                # Reset quiz state
                st.session_state.current_question = 0
                st.session_state.user_answers = []
                st.session_state.start_time = time.time()
                st.rerun()
        
        with col2:
            if st.button("ğŸ“Š View Results", use_container_width=True):
                st.session_state.page = 'results'
                st.rerun()
        
        with col3:
            if st.button("ğŸ  Back to Dashboard", use_container_width=True):
                st.session_state.page = 'dashboard'
                st.rerun()
                
    except Exception as e:
        st.error(f"An error occurred while submitting the quiz: {e}")
        if st.button("ğŸ  Back to Dashboard"):
            st.session_state.page = 'dashboard'
            st.rerun()

def show_results():
    """Display user's quiz results history"""
    st.title("ğŸ“Š My Quiz Results")
    
    # Get user results
    results = db.get_user_results(st.session_state.user_id)
    
    if results:
        st.subheader("Your Quiz History")
        
        # Display results in an expandable format
        for i, result in enumerate(results):
            with st.expander(f"Quiz {i+1} - {result.get('category', 'General')} ({result.get('difficulty', 'Medium')})", expanded=i==0):
                col1, col2, col3, col4 = st.columns(4)
                
                with col1:
                    st.write("**Score**")
                    st.write(f"{result.get('score', 0)}/{result.get('total_questions', 0)}")
                
                with col2:
                    st.write("**Percentage**")
                    percentage = result.get('percentage', 0)
                    if percentage >= 80:
                        st.success(f"{percentage:.1f}%")
                    elif percentage >= 60:
                        st.warning(f"{percentage:.1f}%")
                    else:
                        st.error(f"{percentage:.1f}%")
                
                with col3:
                    st.write("**Time Taken**")
                    st.write(f"{result.get('time_taken', 0):.1f}s")
                
                with col4:
                    st.write("**Date**")
                    created_at = result.get('created_at', 'Unknown')
                    if created_at != 'Unknown':
                        st.write(created_at[:16])
                    else:
                        st.write("N/A")
        
        # Statistics
        st.markdown("---")
        st.subheader("ğŸ“ˆ Statistics")
        
        col1, col2, col3 = st.columns(3)
        
        with col1:
            total_quizzes = len(results)
            st.metric("Total Quizzes", total_quizzes)
        
        with col2:
            avg_score = db.get_user_average_score(st.session_state.user_id)
            st.metric("Average Score", f"{avg_score:.1f}%")
        
        with col3:
            best_score = max([r.get('percentage', 0) for r in results])
            st.metric("Best Score", f"{best_score:.1f}%")
    
    else:
        st.info("No quiz results yet. Take a quiz to see your results here!")
        
        if st.button("Start Your First Quiz", type="primary"):
            st.session_state.page = 'quiz'
            st.rerun()
    
    # Navigation
    st.markdown("---")
    col1, col2 = st.columns(2)
    
    with col1:
        if st.button("ğŸ”„ Take Another Quiz", use_container_width=True):
            st.session_state.page = 'quiz'
            st.rerun()
    
    with col2:
        if st.button("ğŸ  Back to Dashboard", use_container_width=True):
            st.session_state.page = 'dashboard'
            st.rerun()

def main():
    """Main application function"""
    # Initialize database
    init_database()
    
    # Initialize session state
    if 'user_id' not in st.session_state:
        st.session_state.user_id = str(uuid.uuid4())
    
    if 'page' not in st.session_state:
        st.session_state.page = 'dashboard'
    
    # Page navigation
    if st.session_state.page == 'dashboard':
        show_dashboard()
    elif st.session_state.page == 'quiz':
        show_quiz()
    elif st.session_state.page == 'results':
        show_results()

if __name__ == "__main__":
    main()
